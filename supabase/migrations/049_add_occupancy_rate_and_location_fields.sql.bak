-- Add occupancy_rate and location fields to properties table
-- Migration: 049_add_occupancy_rate_and_location_fields.sql

-- Add occupancy_rate field (computed as percentage)
ALTER TABLE properties 
ADD COLUMN occupancy_rate DECIMAL(5,2) GENERATED ALWAYS AS (
  CASE 
    WHEN total_active_units > 0 THEN 
      ROUND(((total_active_units - total_vacant_units)::DECIMAL / total_active_units::DECIMAL) * 100, 2)
    ELSE 0
  END
) STORED;

-- Add location fields
ALTER TABLE properties 
ADD COLUMN borough VARCHAR(100),
ADD COLUMN neighborhood VARCHAR(100),
ADD COLUMN longitude DECIMAL(10, 8),
ADD COLUMN latitude DECIMAL(11, 8),
ADD COLUMN location_verified BOOLEAN DEFAULT FALSE;

-- Add comments for documentation
COMMENT ON COLUMN properties.occupancy_rate IS 'Calculated occupancy rate as percentage: (total_active_units - total_vacant_units) / total_active_units * 100';
COMMENT ON COLUMN properties.borough IS 'Borough or district where the property is located';
COMMENT ON COLUMN properties.neighborhood IS 'Neighborhood or area within the borough';
COMMENT ON COLUMN properties.longitude IS 'Longitude coordinate for property location';
COMMENT ON COLUMN properties.latitude IS 'Latitude coordinate for property location';
COMMENT ON COLUMN properties.location_verified IS 'Whether the location coordinates have been verified';

-- Add indexes for location-based queries
CREATE INDEX IF NOT EXISTS idx_properties_borough ON properties(borough);
CREATE INDEX IF NOT EXISTS idx_properties_neighborhood ON properties(neighborhood);
CREATE INDEX IF NOT EXISTS idx_properties_location ON properties(latitude, longitude) WHERE latitude IS NOT NULL AND longitude IS NOT NULL;
