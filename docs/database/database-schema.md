# Database Schema

The canonical autogenerated schema is in [`DATABASE_SCHEMA.md`](./DATABASE_SCHEMA.md); this file highlights recent changes that engineers should know about.

## Bills overlay (applications, workflow, voids)

- **Tables**:
  - `bill_workflow` (1:1 with bill transaction): tracks approval state, submitted/approved/rejected/voided timestamps, void reversal transaction linkage.
  - `bill_applications` (many-to-many): links payments/credits/refunds to bills with applied amounts, org-scoped. Triggers recompute bill status; reconciled payments are locked from edits. Unique `(bill_transaction_id, source_transaction_id)`.
  - `bill_approval_audit`: append-only audit trail for workflow actions.
- **Functions**:
  - `validate_bill_application(bill_id, source_id, amount)`: enforces application constraints (<= bill total, <= payment total, credits reduce).
  - `recompute_bill_status(bill_transaction_id)`: recomputes payable status from applications.
  - `void_bill(bill_id, user_id, reason)`: creates reversing bill transaction, marks workflow `voided`, audits action; blocks if reconciled payments exist.
  - `resolve_ap_gl_account_id(org_id)`: stable AP account resolution (org config → subtype → name fallback).
- **Sync fields**:
  - Payments include `BillIds[]` built from `bill_applications` for Buildium parity; inbound BillPayments and vendor credits/refunds hydrate `bill_applications`.
  - `transactions.buildium_bill_id` persists Buildium linkage for bills.
- **Approval workflow**: Stored separately from `transactions.status`; states = `draft|pending_approval|approved|rejected|voided`. Amount/line edits blocked when approved; only drafts can be hard-deleted if not synced/no applications.

## Reconciliation locks

- `transactions.is_reconciled` stored generated column, maintained by triggers on `bank_register_state`.
- `bill_applications` trigger prevents update/delete when source payment is reconciled.

## Deposits overlay (20291302000000+)

- **Tables**: `deposit_meta` (1:1 with `transactions.id` for deposits), `deposit_items` (join between deposit transaction and payment transaction).
- **Status enum**: `deposit_status_enum` = `posted | reconciled | voided`. No `open` while deposits are created immediately.
- **Lifecycle rules**: only forward transitions; DB trigger blocks regression from `reconciled` or `voided`.
- **Locking**: reconciliation trigger marks `deposit_meta.status = reconciled`; DB guards prevent bank amount/account/line edits when reconciled.
- **Sync fields**: `deposit_meta` tracks `deposit_id` (human-readable), `buildium_deposit_id`, `buildium_sync_status`, `buildium_last_synced_at`, `buildium_sync_error`.
- **Double‑deposit protection**: `deposit_items` enforces unique `payment_transaction_id` and unique `buildium_payment_transaction_id` (when present).

## Transaction model linkage

- Deposits remain source-of-truth in `transactions` with `transaction_type = 'Deposit'`; `deposit_meta` overlays status/IDs/sync.
- Payment links for deposits should use `deposit_items`; legacy `transaction_payment_transactions` kept for compatibility.
- Reconciliation guardrails apply at the bank-line level; editing reconciled deposits is blocked except memo.

## Backfill reference

- Script: `scripts/backfill-bill-workflow-and-applications.ts`
- DRY RUN: `DRY_RUN=true npx tsx scripts/backfill-bill-workflow-and-applications.ts`
- Live: `npx tsx scripts/backfill-bill-workflow-and-applications.ts`
- Metrics written to `backfill-report-<timestamp>.json`; unresolved `ap_gl_account_id` orgs are reported for manual follow-up.
