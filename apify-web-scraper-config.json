{
    "breakpointLocation": "NONE",
    "browserLog": false,
    "closeCookieModals": false,
    "debugLog": false,
    "downloadCss": true,
    "downloadMedia": true,
    "excludes": [
        {
            "glob": "/**/*.{png,jpg,jpeg,pdf}"
        }
    ],
    "globs": [
        {
            "glob": "https://a810-dobnow.nyc.gov/**/*"
        }
    ],
    "headless": true,
    "ignoreCorsAndCsp": false,
    "ignoreSslErrors": true,
    "injectJQuery": true,
    "keepUrlFragments": true,
    "linkSelector": "",
    "pageFunction": "async function pageFunction(context) {\n    const { log } = context;\n    \n    function sleep(ms) {\n        return new Promise(resolve => setTimeout(resolve, ms));\n    }\n\n    async function waitForSelector(selector, timeoutMs = 15000) {\n        const start = Date.now();\n        while (Date.now() - start < timeoutMs) {\n            const el = document.querySelector(selector);\n            if (el) return el;\n            await sleep(250);\n        }\n        return null;\n    }\n\n    async function waitForText(text, timeoutMs = 15000) {\n        const start = Date.now();\n        while (Date.now() - start < timeoutMs) {\n            const bodyText = document.body.innerText;\n            if (bodyText.toLowerCase().includes(text.toLowerCase())) {\n                return true;\n            }\n            await sleep(250);\n        }\n        return false;\n    }\n\n    function clickElementByText(selector, text) {\n        const elements = document.querySelectorAll(selector);\n        for (const el of elements) {\n            const elText = el.textContent || el.getAttribute('name') || '';\n            if (elText.toLowerCase().includes(text.toLowerCase())) {\n                el.click();\n                return true;\n            }\n        }\n        return false;\n    }\n\n    // Check if we're already on Property Profile page (after navigation)\n    const currentUrl = window.location.href;\n    const bodyText = (document.body.innerText || '').toLowerCase();\n    \n    // If we're on Property Profile page, just wait for POST request\n    if (currentUrl.includes('search') || bodyText.includes('property profile')) {\n        log.info('Already on Property Profile page, waiting for POST request...');\n        \n        // Wait up to 30 seconds for POST request (it happens automatically on page load)\n        for (let i = 0; i < 30; i++) {\n            await sleep(1000);\n            \n            // Check if POST was captured\n            if (context.customData?.capturedPostRequest) {\n                log.info('POST request captured after ' + (i + 1) + ' seconds');\n                break;\n            }\n            \n            if (i % 5 === 0) {\n                log.info('Still waiting for POST request... (' + (i + 1) + ' seconds)');\n            }\n        }\n        \n        return {\n            url: window.location.href,\n            bin: '1088713',\n            capturedPostRequest: context.customData?.capturedPostRequest || null\n        };\n    }\n    \n    // Step 1: Perform BIN search\n    if (currentUrl.indexOf('Index.html#!/') !== -1 && currentUrl.indexOf('search') === -1) {\n        log.info('Step 1: Performing BIN search');\n        log.info('Current URL: ' + currentUrl);\n        log.info('Page ready state: ' + document.readyState);\n        \n        // Wait for page to be fully loaded\n        if (document.readyState !== 'complete') {\n            log.info('Waiting for page to be complete...');\n            await new Promise((resolve) => {\n                if (document.readyState === 'complete') {\n                    resolve();\n                } else {\n                    window.addEventListener('load', resolve, { once: true });\n                    setTimeout(resolve, 10000); // Timeout after 10 seconds\n                }\n            });\n        }\n        \n        // Additional wait for AngularJS/SPA to initialize\n        log.info('Waiting for SPA to initialize...');\n        await sleep(10000);\n        \n        // Click BIN card - try multiple strategies\n        let binCardClicked = false;\n        // Try finding BIN card by searching all clickable elements\n        const allElements = document.querySelectorAll('img, div, button, a, [role=\"button\"]');\n        \n        for (const el of allElements) {\n            const text = (el.getAttribute('name') || el.getAttribute('alt') || el.textContent || '').toLowerCase();\n            if (text.includes('search by bin') || (text.includes('bin') && el.tagName === 'IMG')) {\n                const parent = el.closest('div, button, a') || el;\n                if (parent && parent.click) {\n                    parent.click();\n                    binCardClicked = true;\n                    log.info('Clicked BIN card');\n                    break;\n                }\n            }\n        }\n        \n        if (binCardClicked) {\n            await sleep(3000); // Wait for form to appear\n        } else {\n            log.warning('BIN card not found, trying to continue anyway');\n            await sleep(2000);\n        }\n\n        // Log what's on the page to help debug\n        const allInputs = document.querySelectorAll('input');\n        log.info('Found ' + allInputs.length + ' input elements on page');\n        for (let i = 0; i < Math.min(allInputs.length, 5); i++) {\n            const input = allInputs[i];\n            log.info('Input ' + i + ': type=' + input.type + ', name=' + input.name + ', id=' + input.id + ', placeholder=' + input.placeholder);\n        }\n        \n        // Fill BIN input - try multiple selectors with longer wait\n        let binInput = null;\n        const binInputSelectors = [\n            'input[type=\"text\"]',\n            'input[name*=\"bin\"]',\n            'input[name*=\"BIN\"]',\n            'input[placeholder*=\"BIN\"]',\n            'input[placeholder*=\"bin\"]',\n            'input[id*=\"bin\"]',\n            'input[id*=\"BIN\"]',\n            'input'\n        ];\n        \n        log.info('Trying to find BIN input with ' + binInputSelectors.length + ' selectors...');\n        for (const selector of binInputSelectors) {\n            binInput = await waitForSelector(selector, 10000); // Increased wait time\n            if (binInput) {\n                log.info('Found BIN input using selector: ' + selector);\n                break;\n            } else {\n                log.info('Selector failed: ' + selector);\n            }\n        }\n        \n        if (binInput) {\n            binInput.value = '1088713';\n            binInput.dispatchEvent(new Event('input', { bubbles: true }));\n            binInput.dispatchEvent(new Event('change', { bubbles: true }));\n            // Also trigger focus/blur to ensure AngularJS picks it up\n            binInput.focus();\n            binInput.blur();\n            log.info('Filled BIN input with 1088713');\n            await sleep(1000);\n        } else {\n            log.warning('BIN input not found with any selector');\n        }\n\n        // Log what buttons are on the page\n        const allButtonsOnPage = document.querySelectorAll('button, input[type=\"submit\"], [role=\"button\"]');\n        log.info('Found ' + allButtonsOnPage.length + ' button elements on page');\n        for (let i = 0; i < Math.min(allButtonsOnPage.length, 5); i++) {\n            const btn = allButtonsOnPage[i];\n            log.info('Button ' + i + ': text=' + (btn.textContent || '').substring(0, 50) + ', type=' + btn.type + ', value=' + btn.value);\n        }\n        \n        // Click Search button - try multiple strategies with better event handling\n        let searchClicked = false;\n        \n        // Try finding by text first\n        const allButtons = document.querySelectorAll('button, input[type=\"submit\"], [role=\"button\"], a');\n        for (const btn of allButtons) {\n            const btnText = (btn.textContent || btn.getAttribute('value') || btn.getAttribute('aria-label') || '').toLowerCase();\n            if (btnText.includes('search')) {\n                // Try multiple click methods for better compatibility\n                if (btn.click) {\n                    btn.click();\n                } else if (btn.dispatchEvent) {\n                    btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));\n                }\n                // Also trigger AngularJS if present\n                if (typeof angular !== 'undefined' && angular.element) {\n                    const angularScope = angular.element(btn).scope();\n                    if (angularScope) {\n                        angularScope.$apply();\n                    }\n                }\n                searchClicked = true;\n                log.info('Clicked Search button by text');\n                break;\n            }\n        }\n        \n        // If not found by text, try first submit button or form submit\n        if (!searchClicked) {\n            const submitBtn = document.querySelector('button[type=\"submit\"], input[type=\"submit\"]');\n            if (submitBtn) {\n                submitBtn.click();\n                searchClicked = true;\n                log.info('Clicked Search button (submit button)');\n            } else {\n                // Try submitting the form directly\n                const form = binInput ? binInput.closest('form') : null;\n                if (form && form.submit) {\n                    form.submit();\n                    searchClicked = true;\n                    log.info('Submitted form directly');\n                }\n            }\n        }\n        \n        if (searchClicked) {\n            log.info('Search button clicked - returning immediately to avoid execution context destruction');\n            \n            // Return immediately - any wait will cause execution context destruction\n            // Apify's waitUntil: networkidle2 will wait for all requests to complete\n            // Hooks (set up in preNavigationHooks/postNavigationHooks) will capture the POST request\n            // The POST happens automatically when Property Profile loads (one of first 10 calls)\n            return {\n                url: window.location.href,\n                bin: '1088713',\n                message: 'Search clicked, hooks will capture POST request when Property Profile loads',\n                capturedPostRequest: context.customData?.capturedPostRequest || null\n            };\n        } else {\n            log.warning('Search button not found');\n            return {\n                url: window.location.href,\n                bin: '1088713',\n                error: 'Search button not found',\n                capturedPostRequest: null\n            };\n        }\n    }\n\n    // Extract results - try multiple ways to access customData\n    const capturedRequest = context.customData?.capturedPostRequest || \n                           context.request?.userData?.capturedPostRequest || \n                           null;\n    \n    const result = {\n        url: window.location.href,\n        bin: '1088713',\n        capturedPostRequest: capturedRequest\n    };\n\n    if (!result.capturedPostRequest) {\n        log.warning('POST request not captured. Check logs for intercepted requests.');\n        log.info('customData available:', typeof context.customData !== 'undefined');\n    } else {\n        log.info('Successfully captured POST request');\n    }\n\n    return result;\n}",
    "postNavigationHooks": "[\n    async (crawlingContext) => {\n        const page = crawlingContext.page;\n        if (!page) return;\n        \n        // Initialize customData if not exists\n        if (!crawlingContext.customData) {\n            crawlingContext.customData = {};\n        }\n        \n        // Log that postNavigationHooks ran (to verify it's being called)\n        crawlingContext.log.info('postNavigationHooks: Setting up response listener for page: ' + page.url());\n        \n        // Set up response listener to capture POST request details (case-insensitive)\n        page.on('response', async (response) => {\n            const responseUrl = response.url();\n            const url = responseUrl.toLowerCase();\n            const request = response.request();\n            const method = request.method();\n            \n            // Log all POST responses to help debug (fix serialization)\n            if (method === 'POST') {\n                crawlingContext.log.info('POST response detected: ' + responseUrl);\n            }\n            \n            // Log any response from PublicPortal.svc to see what endpoints are being called\n            if (url.includes('publicportal.svc')) {\n                crawlingContext.log.info('PublicPortal.svc response: ' + method + ' ' + responseUrl + ' Status: ' + response.status());\n            }\n            \n            // Check for the target endpoint (case-insensitive, multiple patterns)\n            // URL: https://a810-dobnow.nyc.gov/Publish/WrapperPP/PublicPortal.svc/GetPublicPortalELV3Devices\n            const matchesTarget = url.includes('getpublicportalelev3devices') || \n                                 url.includes('elv3devices') || \n                                 (url.includes('publicportal') && url.includes('elv') && url.includes('device') && method === 'POST');\n            \n            if (matchesTarget) {\n                const postData = request.postData();\n                const headers = request.headers();\n                \n                crawlingContext.log.info('=== CAPTURED POST REQUEST (from response) ===');\n                crawlingContext.log.info('URL:', response.url());\n                crawlingContext.log.info('Method:', request.method());\n                crawlingContext.log.info('Headers:', JSON.stringify(headers, null, 2));\n                crawlingContext.log.info('Body:', postData);\n                crawlingContext.log.info('Status:', response.status());\n                crawlingContext.log.info('==============================================');\n                \n                // Store in customData and request userData\n                crawlingContext.customData.capturedPostRequest = {\n                    url: response.url(),\n                    method: request.method(),\n                    headers: headers,\n                    body: postData\n                };\n                \n                // Also store in request userData if available\n                if (crawlingContext.request) {\n                    if (!crawlingContext.request.userData) {\n                        crawlingContext.request.userData = {};\n                    }\n                    crawlingContext.request.userData.capturedPostRequest = crawlingContext.customData.capturedPostRequest;\n                }\n            }\n        });\n    },\n]",
    "preNavigationHooks": "[\n    async (crawlingContext, gotoOptions) => {\n        const page = crawlingContext.page;\n        if (!page) return;\n        \n        // Initialize customData if not exists\n        if (!crawlingContext.customData) {\n            crawlingContext.customData = {};\n        }\n        \n        // Log that preNavigationHooks ran\n        crawlingContext.log.info('preNavigationHooks: Setting up request interception for page: ' + (page.url() || 'initial'));\n        \n        // Enable request interception to catch all requests\n        await page.setRequestInterception(true);\n        \n        // Set up request listener to capture POST request (case-insensitive)\n        page.on('request', (request) => {\n            const requestUrl = request.url();\n            const url = requestUrl.toLowerCase();\n            const method = request.method();\n            \n            // Log all POST requests to help debug (fix serialization)\n            if (method === 'POST') {\n                crawlingContext.log.info('POST request detected: ' + requestUrl);\n            }\n            \n            // Log any request to PublicPortal.svc to see what endpoints are being called\n            if (url.includes('publicportal.svc')) {\n                crawlingContext.log.info('PublicPortal.svc request: ' + method + ' ' + requestUrl);\n            }\n            \n            // Check for the target endpoint (case-insensitive, multiple patterns)\n            // URL: https://a810-dobnow.nyc.gov/Publish/WrapperPP/PublicPortal.svc/GetPublicPortalELV3Devices\n            const matchesTarget = url.includes('getpublicportalelev3devices') || \n                                 url.includes('elv3devices') || \n                                 (url.includes('publicportal') && url.includes('elv') && url.includes('device') && method === 'POST');\n            \n            if (matchesTarget) {\n                const postData = request.postData();\n                const headers = request.headers();\n                \n                crawlingContext.log.info('=== INTERCEPTED POST REQUEST ===');\n                crawlingContext.log.info('URL:', request.url());\n                crawlingContext.log.info('Method:', method);\n                crawlingContext.log.info('Headers:', JSON.stringify(headers, null, 2));\n                crawlingContext.log.info('Post Data:', postData);\n                crawlingContext.log.info('================================');\n                \n                // Store in customData and request userData\n                crawlingContext.customData.capturedPostRequest = {\n                    url: request.url(),\n                    method: method,\n                    headers: headers,\n                    body: postData\n                };\n                \n                // Also store in request userData if available\n                if (crawlingContext.request) {\n                    if (!crawlingContext.request.userData) {\n                        crawlingContext.request.userData = {};\n                    }\n                    crawlingContext.request.userData.capturedPostRequest = crawlingContext.customData.capturedPostRequest;\n                }\n            }\n            \n            // Continue the request (required when interception is enabled)\n            request.continue();\n        });\n    },\n]",
    "proxyConfiguration": {
        "useApifyProxy": true
    },
    "respectRobotsTxtFile": true,
    "runMode": "DEVELOPMENT",
    "startUrls": [
        {
            "url": "https://a810-dobnow.nyc.gov/publish/Index.html#!/"
        }
    ],
    "useChrome": true,
    "waitUntil": [
        "networkidle2"
    ],
    "navigationTimeoutSecs": 120
}
